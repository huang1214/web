<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.aca.springboot.mapper.BillMapper">

    <resultMap id="BVO" type="com.aca.springboot.vo.BillVO">
        <id property="bid" column="BID"/>
        <result property="ctid" column="CTID"/>
        <result property="cyear" column="CYEAR"/>
        <result property="clevel" column="CLEVEL"/>
        <result property="cdesc" column="CDESC"/>
        <result property="groupleader" column="GROUPLEADER"/>
        <result property="groupname" column="GROUPNAME"/>
        <result property="resultType" column="RESULT_TYPE"/>
        <result property="workName" column="WORK_NAME"/>
        <result property="preditfeedesc" column="PREDITFEEDESC"/>
        <result property="predictfee" column="PREDICTFEE"/>
        <result property="state" column="STATE"/>
        <result property="attachfile" column="ATTACHFILE"/>
        <result property="note" column="NOTE"/>
        <association property="competition" javaType="com.aca.springboot.entities.Competition">
            <id property="ctid" column="ctid"/>
            <result property="ctname" column="ctname"/>
            <result property="host_unit" column="host_unit"/>
            <result property="com_type" column="com_type"/>
            <result property="result_type" column="result_type"/>
            <result property="reference_paper" column="reference_paper"/>
        </association>
        <association property="student"  javaType="com.aca.springboot.entities.Student">
            <id property="sno" column="sno"/>
            <result property="sname" column="sname"/>
            <result property="ssex" column="ssex"/>
            <result property="sbirthday" column="sbirthday"/>
            <result property="sdomitory" column="sdomitory"/>
            <result property="cno" column="cno"/>
            <result property="spwd" column="spwd"/>
            <result property="stel" column="stel"/>
            <result property="state" column="state"/>
            <result property="card_num" column="card_num"/>
        </association>
        <collection property="students" javaType="java.util.ArrayList" ofType="com.aca.springboot.entities.Student">
            <id property="sno" column="ST_SNO"/>
            <result property="sname" column="ST_SNAME"/>
            <result property="ssex" column="ST_SSEX"/>
            <result property="sbirthday" column="ST_SBIRTHDAY"/>
            <result property="sdomitory" column="ST_SDOMITORY"/>
            <result property="cno" column="ST_CNO"/>
            <result property="spwd" column="ST_SPWD"/>
            <result property="stel" column="ST_STEL"/>
            <result property="state" column="ST_STATE"/>
            <result property="card_num" column="ST_CARD_NUM"/>
        </collection>
        <collection property="teachers" ofType="com.aca.springboot.entities.Teacher">
            <id property="tno" column="TE_TNO"/>
            <result property="tname" column="TE_TNAME"/>
            <result property="tsex" column="TE_TSEX"/>
            <result property="tbirthday" column="TE_TBIRTHDAY"/>
            <result property="dno" column="TE_DNO"/>
            <result property="ttel" column="TE_TTEL"/>
            <result property="ttitle" column="TE_TTITLE"/>
            <result property="tpwd" column="TE_TPWD"/>
            <result property="tstate" column="TE_TSTATE"/>
            <result property="card_num" column="TE_CARD_NUM"/>
        </collection>

    </resultMap>

    <!--根据竞赛编号，参赛年费，团队负责人查询报销-->
    <select id="selectBillByCtidCyearGroupleader" parameterType="com.aca.springboot.entities.Bill" resultType="com.aca.springboot.entities.Bill">
        select bid, ctid, cyear, clevel, cdesc, groupleader, groupname, RESULT_TYPE, WORK_NAME, preditfeedesc, predictfee, state,note from BILL where CTID= #{ctid} and CYEAR=#{cyear} and
            GROUPLEADER = #{groupleader}
    </select>

    <!--插入账单表-->
    <insert id="addBill" parameterType="com.aca.springboot.entities.Bill">
        insert into BILL(bid, ctid, cyear, clevel, cdesc, groupleader, groupname,  WORK_NAME, preditfeedesc, predictfee, state, attachfile)
        values (#{bid}, #{ctid}, #{cyear}, #{clevel}, #{cdesc}, #{groupleader}, #{groupname},  #{workName}, #{preditfeedesc}, #{predictfee}, #{state}, #{attachfile})
    </insert>

    <!--插入账单对应表-->
    <insert id="addBillMember" parameterType="com.aca.springboot.entities.BillMember">
        insert into BILL_MEMBER(BILL_ID, BILL_TM_ID,BILL_TYPE ,BILL_ORDER)
        values (#{billId},#{billTmId},#{billType},#{billOrder})
    </insert>

    <!--取得BVO-->
    <parameterMap id="get_bill_list_params" type="java.util.Map">
    </parameterMap>
    <select id="get_bill_list" parameterMap="get_bill_list_params" resultMap="BVO">
        SELECT * FROM (SELECT ROWNUM rn, b.* FROM (SELECT * from (select * from BILL
        where BID IN (SELECT BILL_ID FROM BILL_MEMBER WHERE BILL_TM_ID = #{SNO} ) order by bill.STATE desc) B
        JOIN  BILL_MEMBER BM on BM.BILL_ID = B.BID
        JOIN com_table  C ON B.ctid=C.ctid
        JOIN STUDENT S ON S.SNO=B.GROUPLEADER
        left join  STUDENT ST on BM.BILL_TM_ID = ST.SNO and BM.BILL_TYPE = '1'
        left join TEACHER TE on BM.BILL_TM_ID = TE.TNO and BM.BILL_TYPE = '2') b)
        WHERE rn>=#{LEFT} AND rn &lt;=#{RIGHT}
    </select>

    <!--管理员获取全部的竞赛信息-->
    <select id="get_all_bill_list" resultMap="BVO">
        SELECT * FROM (SELECT ROWNUM rn, b.* FROM (select * from (select * from BILL) B
        JOIN BILL_MEMBER BM on BM.BILL_ID = B.BID
        JOIN  com_table  C ON B.ctid=C.ctid
        JOIN  STUDENT S ON S.SNO=B.GROUPLEADER
        left join  STUDENT ST on BM.BILL_TM_ID = ST.SNO and BM.BILL_TYPE = '1'
        left join  TEACHER TE on BM.BILL_TM_ID = TE.DNO and BM.BILL_TYPE = '2') b)
        WHERE rn>=#{LEFT} AND rn &lt;=#{RIGHT}
    </select>

    <update id="change_bill_state" parameterType="java.util.Map">
        update bill set STATE = #{STATE},NOTE = #{NOTE} where BID = #{BID}
    </update>

    <!--删除bill表中信息-->
    <delete id="deleteBill" parameterType="java.util.Map">
        delete BILL where BID = #{BID}
    </delete>

    <!--删除billMember表中信息-->
    <delete id="deleteBillMember" parameterType="java.util.Map">
        delete BILL_MEMBER where BILL_ID = #{BID}
    </delete>

    <select id="getBillCount" parameterType="java.util.Map" resultType="java.lang.Integer">
        SELECT COUNT(*)  FROM BILL b JOIN BILL_MEMBER m ON b.BID=m.BILL_ID
        WHERE STATE=#{STATE} AND BILL_TM_ID=#{SNO}
    </select>
    <select id="getBillCountNotState" parameterType="java.util.Map" resultType="java.lang.Integer">
        SELECT COUNT(*)  FROM BILL b JOIN BILL_MEMBER m ON b.BID=m.BILL_ID
        WHERE  BILL_TM_ID=#{SNO}
    </select>
    <select id="getBillCountAdmin" parameterType="java.util.Map" resultType="java.lang.Integer">
        SELECT COUNT(*)  FROM BILL WHERE STATE=#{STATE}
    </select>
    <select id="getBillCountAdminNotState" parameterType="java.util.Map" resultType="java.lang.Integer">
        SELECT COUNT(*)  FROM BILL
    </select>
</mapper>